
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------
    //
    // HELPER FUNCTIONS
    //
    // --------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated (signed in).
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is a member of a given channel.
     * This is the secure and efficient way to check for membership.
     * @param channelId The ID of the channel to check.
     */
    function isChannelMember(channelId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/channels/$(channelId)).data.members;
    }

    /**
     * Returns true if the user is the owner of a given channel.
     * @param channelId The ID of the channel to check.
     */
    function isChannelOwner(channelId) {
        return isSignedIn() && request.auth.uid == get(/databases/$(database)/documents/channels/$(channelId)).data.ownerId;
    }

    // --------------------------------------------------------------------------
    //
    // COLLECTION: users
    //
    // --------------------------------------------------------------------------

    // This rule applies to the ENTIRE /users collection.
    // It explicitly forbids `list` (querying the whole collection) and `write`
    // (creating/updating documents without a specific document match).
    // This is a critical security measure to prevent data scraping.
    match /users {
      allow list, write: if false;
    }

    // This rule applies to INDIVIDUAL documents within the /users collection.
    match /users/{userId} {
      /**
       * @allow (get) Any authenticated user can read another user's profile.
       * This is necessary for search, DMs, and viewing profiles.
       * We will make client-side queries targeted and efficient to avoid needing a broad 'list' permission.
       *
       * @allow (create, update) A user can only create or update THEIR OWN profile.
       *
       * @allow (delete) Deleting user profiles is disallowed for safety.
       */
      allow get: if isSignedIn();
      allow create, update: if isOwner(userId);
      allow delete: if false; // Safety: prevent users from deleting their accounts through the client.
    }


    // --------------------------------------------------------------------------
    //
    // COLLECTION: channels and subcollections
    //
    // --------------------------------------------------------------------------

    match /channels/{channelId} {
      /**
       * @allow (get, update) Full read/update access is granted only to members of the channel.
       * @allow (list) Users can only list channels they are members of. This requires a `where('members', 'array-contains', request.auth.uid)` clause on the client-side query.
       * @allow (create) Any signed-in user can create a new channel, provided they include themselves as a member and the owner.
       * @allow (delete) Only the channel's designated owner can delete it.
       */
      allow get, update: if isChannelMember(channelId);
      // NOTE: `list` on a collection requires a client-side query constraint to be secure and effective.
      // The rule itself can be broad, but the client query MUST filter by the user's UID.
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.members && request.resource.data.ownerId == request.auth.uid;
      allow delete: if isChannelOwner(channelId);

      // SUB-COLLECTION: messages
      match /messages/{messageId} {
        /**
         * @allow (read, list) Users can only read messages if they are a member of the parent channel.
         * @allow (create) A user can only create a message if they are a channel member, and they must be the author.
         * @allow (update) Users can only update their own messages.
         * @allow (delete) Users can delete their own messages. Channel owners can also delete any message in their channel.
         */
        allow read, list: if isChannelMember(channelId);
        allow create: if isChannelMember(channelId) && request.resource.data.authorId == request.auth.uid;
        allow update: if isChannelMember(channelId) && resource.data.authorId == request.auth.uid;
        allow delete: if isChannelMember(channelId) && (resource.data.authorId == request.auth.uid || isChannelOwner(channelId));
      }
    }
  }
}
