rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Returns true if the document being written to already exists.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Returns true if the user is a member of a given channel.
     * Relies on the denormalized `members` array-contains check in the rule itself.
     * This is NOT for use with get() calls.
     */
    function isChannelMember(channelId) {
       return isSignedIn() && exists(/databases/$(database)/documents/channels/$(channelId)) && request.auth.uid in get(/databases/$(database)/documents/channels/$(channelId)).data.members;
    }

    /**
     * Returns true if the user is the owner of a given channel.
     */
    function isChannelOwner(channelId) {
      return isSignedIn() && exists(/databases/$(database)/documents/channels/$(channelId)) && request.auth.uid == get(/databases/$(database)/documents/channels/$(channelId)).data.ownerId;
    }

    // --------------------------------------------------------------------------
    // Collection Group & Wildcard Rules
    // --------------------------------------------------------------------------

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (read) Any signed-in user can read any user's profile.
     * @allow (write) A user can only create, update, or delete their own profile.
     */
    match /users/{userId} {
      allow get, list: if isSignedIn();
      allow write: if isOwner(userId);
    }

    /**
     * @description Controls access to channels. Access is based on a denormalized members list.
     * @path /channels/{channelId}
     * @allow (read/list) A user can only read channels they are a member of.
     * @allow (create) A user can create a channel if they include themselves as the owner and a member.
     * @allow (update) Only the channel owner can update a channel.
     * @allow (delete) Only the channel owner can delete a channel.
     */
    match /channels/{channelId} {
      allow read, update, delete: if isChannelMember(channelId);
      allow list: if isSignedIn(); // List queries should be filtered on the client with `where('members', 'array-contains', request.auth.uid)`
      allow create: if isSignedIn() && 
                      request.resource.data.ownerId == request.auth.uid &&
                      request.auth.uid in request.resource.data.members;
    }

    /**
     * @description Controls access to messages within a channel. Permissions are inherited.
     * @path /channels/{channelId}/messages/{messageId}
     * @allow (read/list) A user can read messages in channels they are a member of.
     * @allow (create) A user can create a message in a channel they are a member of, and must be the author.
     * @allow (update/delete) A user can only modify their own messages. Channel owners can also delete any message.
     */
    match /channels/{channelId}/messages/{messageId} {
      allow read, list: if isChannelMember(channelId);
      allow create: if isChannelMember(channelId) && request.resource.data.authorId == request.auth.uid;
      allow update: if isChannelMember(channelId) && resource.data.authorId == request.auth.uid;
      allow delete: if isChannelMember(channelId) && (resource.data.authorId == request.auth.uid || isChannelOwner(channelId));
    }
    
    /**
     * @description Controls access to attachments within a message. Permissions are inherited.
     * @path /channels/{channelId}/messages/{messageId}/attachments/{attachmentId}
     * @allow (read/list) A user can read attachments in channels they are a member of.
     * @allow (create) A user can add an attachment in a channel they are a member of.
     * @allow (update) Attachments are immutable.
     * @allow (delete) The message author or channel owner can delete attachments.
     */
    match /channels/{channelId}/messages/{messageId}/attachments/{attachmentId} {
        allow read, list: if isChannelMember(channelId);
        allow create: if isChannelMember(channelId);
        allow update: if false;
        allow delete: if isChannelMember(channelId) && (get(/databases/$(database)/documents/channels/$(channelId)/messages/$(messageId)).data.authorId == request.auth.uid || isChannelOwner(channelId));
    }
  }
}
