
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------
    //
    // HELPER FUNCTIONS
    //
    // --------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated (signed in).
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is a member of a given channel.
     * This is the secure and efficient way to check for membership.
     * @param channelId The ID of the channel to check.
     */
    function isChannelMember(channelId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/channels/$(channelId)).data.members;
    }

    /**
     * Returns true if the user is the owner of a given channel.
     * @param channelId The ID of the channel to check.
     */
    function isChannelOwner(channelId) {
        return isSignedIn() && request.auth.uid == get(/databases/$(database)/documents/channels/$(channelId)).data.ownerId;
    }

    // --------------------------------------------------------------------------
    //
    // COLLECTION: users
    //
    // --------------------------------------------------------------------------

    match /users/{userId} {
      /**
       * @allow (read, list) Anyone can read user profiles and list users.
       * @allow (create, update) A user can only create or update THEIR OWN profile.
       * @allow (delete) Deleting user profiles is disallowed for safety.
       */
      allow read, list: if true;
      allow create, update: if isOwner(userId);
      allow delete: if false; 
    }

    // --------------------------------------------------------------------------
    //
    // COLLECTION: channels and subcollections
    //
    // --------------------------------------------------------------------------

    match /channels/{channelId} {
      /**
       * @allow (read, list) Anyone can read and list channels.
       * @allow (update) Full update access is granted only to members of the channel.
       * @allow (create) Any signed-in user can create a new channel, provided they include themselves as a member and the owner.
       * @allow (delete) Only the channel's designated owner can delete it.
       */
      allow read, list: if true;
      allow update: if isChannelMember(channelId);
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.members && request.resource.data.ownerId == request.auth.uid;
      allow delete: if isChannelOwner(channelId);

      // SUB-COLLECTION: messages
      match /messages/{messageId} {
        /**
         * @allow (read, list) Anyone can read messages in any channel.
         * @allow (create) A user can only create a message if they are a channel member, and they must be the author.
         * @allow (update) Users can only update their own messages.
         * @allow (delete) Users can delete their own messages. Channel owners can also delete any message in their channel.
         */
        allow read, list: if true;
        allow create: if isChannelMember(channelId) && request.resource.data.authorId == request.auth.uid;
        allow update: if isChannelMember(channelId) && resource.data.authorId == request.auth.uid;
        allow delete: if isChannelMember(channelId) && (resource.data.authorId == request.auth.uid || isChannelOwner(channelId));
      }
    }
  }
}
