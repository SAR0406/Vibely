
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------
    //
    // HELPER FUNCTIONS
    //
    // These functions are reusable snippets of logic that make the rules
    // below easier to read and maintain.
    //
    // --------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated (signed in).
     * This is the most basic check for almost all rules.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the core of the user-ownership security model.
     * @param userId The UID to check against the authenticated user.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is a member of a given channel.
     * This function performs a direct read on the channel document to check
     * if the requesting user's UID is present in the `members` array.
     * This is a secure and efficient way to check for membership.
     * @param channelId The ID of the channel to check membership for.
     */
    function isChannelMember(channelId) {
      // get() returns the document's resource object. We check `data.members` for the UID.
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/channels/$(channelId)).data.members;
    }

    /**
     * Returns true if the user is the owner of a given channel.
     * @param channelId The ID of the channel to check ownership of.
     */
    function isChannelOwner(channelId) {
        return isSignedIn() && request.auth.uid == get(/databases/$(database)/documents/channels/$(channelId)).data.ownerId;
    }


    // --------------------------------------------------------------------------
    //
    // COLLECTION: users
    //
    // This collection stores the profile information for each user.
    //
    // --------------------------------------------------------------------------
    
    match /users/{userId} {
      /**
       * @allow (get, list) Any authenticated user can read/list user profiles. This is crucial for user search and profile viewing.
       * @allow (create, update) A user can only create or update THEIR OWN profile.
       * @allow (delete) Deleting user profiles is disallowed for safety.
       */
      allow get, list: if isSignedIn();
      allow create, update: if isOwner(userId);
      allow delete: if false;
    }


    // --------------------------------------------------------------------------
    //
    // COLLECTION: channels
    //
    // Stores all channel data, including public channels, private groups, and DMs.
    // Access is strictly controlled by the `members` array in each document.
    //
    // --------------------------------------------------------------------------

    match /channels/{channelId} {
      /**
       * @allow (read, write) Full read/write access is granted only to members of the channel.
       * @allow (create) Any signed-in user can create a new channel, provided they include themselves as a member and the owner.
       * @allow (list) Users can only list channels they are members of. This requires a `where('members', 'array-contains', request.auth.uid)` clause on the client-side query.
       * @allow (delete) Only the channel's designated owner can delete it.
       */
      allow read, update: if isChannelMember(channelId);
      allow list: if isSignedIn(); // List queries MUST be filtered on the client with `where('members', 'array-contains', request.auth.uid)`
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.members && request.resource.data.ownerId == request.auth.uid;
      allow delete: if isChannelOwner(channelId);

      // ------------------------------------------------------------------------
      // SUB-COLLECTION: messages
      //
      // Stores messages for a specific channel. Permissions are inherited from
      // the parent channel.
      // ------------------------------------------------------------------------

      match /messages/{messageId} {
        /**
         * @allow (read, list) Users can only read messages if they are a member of the parent channel.
         * @allow (create) A user can only create a message if they are a channel member, and they must be the author.
         * @allow (update) Users can only update their own messages.
         * @allow (delete) Users can delete their own messages. Channel owners can also delete any message in their channel.
         */
        allow read, list: if isChannelMember(channelId);
        allow create: if isChannelMember(channelId) && request.resource.data.authorId == request.auth.uid;
        allow update: if isChannelMember(channelId) && resource.data.authorId == request.auth.uid;
        allow delete: if isChannelMember(channelId) && (resource.data.authorId == request.auth.uid || isChannelOwner(channelId));
      }
    }
  }
}
